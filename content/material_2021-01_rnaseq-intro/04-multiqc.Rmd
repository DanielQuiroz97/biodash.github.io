---
title: "FastQC at OSC"
output:
  xaringan::moon_reader:
    seal: false
    css: ["default", "default-fonts", "slides.css"]
    lib_dir: libs
    nature:
      highlightStyle: rainbow
      highlightLines: true
      countIncrementalSlides: false
---
class:inverse middle center

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)

knitr::opts_chunk$set(eval = FALSE)
```

# Running MultiQC at OSC

----

<br> <br> <br>

### Jelmer Poelstra, MCIC Wooster
### 2021/02/05 (updated: `r Sys.Date()`)

  
---

## MultiQC

MultiQC is a program that nicely summarizes FastQC results for any number of
fastq files.

- MultiQC is not available as a module at OSC.

  The easiest way to use it at OSC is by installing it via `conda` as follows:

  ```sh
  $ module load python/3.6-conda5.2
  
  $ conda create --name multiqc python=3.7
  $ conda activate multiqc
  $ conda install -c bioconda -c conda-forge multiqc
  ```

---

## conda setup

- If you haven't used conda before, you can set it up *at Pitzer* as follows:

```sh
# This will add a line to your bash config file,
# which runs every time you start a shell,
# to run the conda setup script:
$ echo ". /apps/python/3.6-conda5.2/etc/profile.d/conda.sh" >> ~/.bashrc

# Next, we source (run) the config file in our current shell,
# to also run the conda setup script right now:
$ source ~/.bashrc
```

--

- Whenever you want to use a `conda` environment at OSC,
  you need to first load the module, and then *activate* the conda environment
  that you want:

```sh
$ module load python/3.6-conda5.2
$ conda activate /users/PAS0471/jelmer/.conda/envs/multiqc
```

- Having done that, you should be able to run MultiQC:

```sh
$ multiqc --help
```

---

## Running MultiQC

Running MultiQC, like FastQC, is straightforward:

```sh
# This will put the MultiQC report in the working dir:
$ multiqc <dir-with-fastqc-reports>

# You can also specify the output dir for the MultiQC report: 
$ multiqc <dir-with-fastqc-reports> -o <output-dir>
```

For example:

```sh
$ multiqc analysis/QC_fastq -o analysis/QC_fastq/
```

---

## MultiQC script - part 1 of 2

```sh
#!/bin/bash
#SBATCH --account=PAS0471
#SBATCH --time=60
#SBATCH --out=slurm-multiqc-%j.out

set -e -u -o pipefail

# Save command-line arguments in named variables:
input_dir="$1"
output_dir="$2" 

# If necessary, create the output dir:
mkdir -p "$output_dir"

# Report before starting the pogram:
echo "Starting MultiQC script..."
date
echo "Running MultiQC for dir: $input_dir"
echo "Output dir: $output_dir"
echo "Number of files: $(find "$input_dir" -name "*fastqc.html" | wc -l)"
echo -e "---------\n\n"
```

---

## MultiQC script - part 2 of 2

```sh
# Load the conda module and the MultiQC conda environment:
module load python/3.6-conda5.2
source /apps/python/3.6-conda5.2/etc/profile.d/conda.sh
conda activate /users/PAS0471/jelmer/.conda/envs/multiqc

# Run fastqc:
multiqc "$input_dir" -o "$output_dir"

# Report:
echo -e "\n---------\nAll done!"
date
```

---

## MultiQC script

.content-box-warning[
In the script, it is necessary to always run the `conda` setup script:

```sh
source /apps/python/3.6-conda5.2/etc/profile.d/conda.sh
```
]

---
class: inverse middle center

# Questions?

----

<br> <br> <br> <br>
