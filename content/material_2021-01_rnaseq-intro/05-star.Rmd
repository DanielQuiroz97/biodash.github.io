---
title: "RNAseq read alignment with STAR at OSC"
output:
  xaringan::moon_reader:
    seal: false
    css: ["default", "default-fonts", "slides.css"]
    lib_dir: libs
    nature:
      highlightStyle: rainbow
      highlightLines: true
      countIncrementalSlides: false
---
class:inverse middle center

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)

knitr::opts_chunk$set(eval = FALSE)
```

# RNAseq read alignment with STAR at OSC

----

<br> <br> <br>

### Jelmer Poelstra, MCIC Wooster
### 2021/02/12 (updated: `r Sys.Date()`)
  
---

## Overview of the analysis pipeline

<p align="center">
<img src=img/pipeline-overview2.png width="90%">
</p>

---

## Aligning RNAseq reads

The purpose of aligning reads, also known as *mapping*:  
determine where in the genome each read originates from.
  
This information forms the basis of generate read counts for each gene for
each sample (`featureCounts` step).

**ADD IMG**

---

## Aligning RNAseq reads (cont.)

Aligning RNAseq reads is more challenging than DNA reads:
due to *splicing*, many reads can't be simply be mapped wholly to the genome.
  
Moreover, there is often *alternative splicing*,
such that a single "correct" reference is simply not applicable.
  
Therefore, RNAseq mappers have to be "splice-aware".

<br>

<figure>
<p align="center">
<img src="img/star-map.png" width="80%">
<figcaption>Figure from Dobin et al. 2013</figcaption>
</p>
</figure>


---

## The STAR aligner

**About STAR:**

- STAR is an acronym for "Spliced Transcripts Alignment to a Reference".

- Reference paper &ndash; Dobin et al. 2013, *Bioinformatics*: [STAR: ultrafast
  universal RNA-seq aligner](https://academic.oup.com/bioinformatics/article/29/1/15/272537).

- [This page](https://hbctraining.github.io/Intro-to-rnaseq-hpc-O2/lessons/03_alignment.html)
  has a nice quick, visual explanation of STAR's alignment strategy.

- It's a very fast aligner, but memory-intensive. Luckily we have OSC!

--

<br>

.content-box-info[
Before we can perform the mapping, we also need to index the genome with STAR.
Every mapper has its own mapping algorith and associated with that also its
own way to create a genome dictionary.
]

---

## STAR at OSC

- STAR is available in a module at OSC. The Owens cluster has a more recent
  version available, so make sure to log in to the Owens cluster.

  ```sh
  $ cd /fs/project/PAS0471/teach/misc/2021-02_rnaseq/$USER
  ```
  
  ```sh
  $ module load star/2.6.0a
  ```

---

## STAR options for genome indexing

Some options when generating a genome index with STAR are as follows:

| Option                        | Meaning
|-------------------------------|---------
| `--runThreadN 16`             | Use 16 cores/threads
| `--runMode genomeGenerate`    | The mode to index a genome
| `--genomeDir mydir`           | Destination dir for index 
| `--genomeFastaFiles my.fasta` | Path to the genome FASTA file
| `--sjdbGTFfile my.gtf`        | Path to the genome GTF file
| `--sjdbOverhang ReadLength-1` | Length of the donor/acceptor sequence <br> on each side of the junctions
| `--genomeSAindexNbases 14`    | Length of the SA pre-indexing string


.content-box-info[
According to the documentation,  
the value of `genomeSAindexNbases` should be:

`log2(GenomeLength)/2 - 1)` => `log2(782520133)/2 - 1)` = 13.77 = 14
]

---

## The key parts of a script to index the genome

```sh
#!/bin/bash
#SBATCH --account=PAS0471
#SBATCH --time=2:00:00
#SBATCH --cpus-per-task=28
module load star/2.6.0a

STAR --runThreadN "$SLURM_CPUS_ON_NODE" \
    --runMode genomeGenerate \
    --genomeDir "$index_dir" \
    --genomeFastaFiles "$ref_fa" \
    --sjdbGTFtagExonParentTranscript "$ref_gff" \
    --genomeSAindexNbases 13 \
    --sjdbOverhang ReadLength-1
```

--

Submit the script:

```sh
$ ref_fa=data/ref/Heinz1706_4.00/S_lycopersicum_chromosomes.4.00.fa
$ ref_gff=data/ref/annot/ITAG4.1/ITAG4.1_gene_models.gff
$ index_dir=data/ref/Heinz1706_4.00/STAR_index

$ sbatch scripts/align/star_index.sh \
    "$ref_fa" "$ref_gff" "$index_dir"
#> Submitted batch job 12826056
```

---

## Check the output

```sh
$ ls
#> slurm-STAR-index-12826056.out Log.out

$ cat slurm-STAR-index-12826056.out
#> Feb 10 14:53:19 ..... started STAR run
#> Feb 10 14:53:19 ... starting to generate Genome files
#> Feb 10 14:53:34 ... starting to sort Suffix Array. This may take a long time...
#> Feb 10 14:53:39 ... sorting Suffix Array chunks and saving them to disk...
#> Feb 10 14:55:09 ... loading chunks from disk, packing SA...
#> Feb 10 14:55:28 ... finished generating suffix array
#> Feb 10 14:55:28 ... generating Suffix Array index
#> Feb 10 14:56:15 ... completed Suffix Array index
#> Feb 10 14:56:15 ... writing Genome to disk ...
#> Feb 10 14:56:15 ... writing Suffix Array to disk ...
#> Feb 10 14:56:18 ... writing SAindex to disk
#> Feb 10 14:56:18 ..... finished successfully
```

---

## Check the output (cont.)

STAR also automatically outputs a file `Log.out` with lots of information
about the run:
  
```sh
$ less Log.out

#> STAR version=STAR_2.6.0a
#> STAR compilation time,server,dir=Mon Apr 23 13:19:26 EDT 2018 #> florence.cshl.edu:/sonas-hs/gingeras/nlsas_norepl/user/dobin/STAR/STAR.master/source
#> ##### DEFAULT parameters:
#> versionSTAR                       20201
#> versionGenome                     20101   20200   
#> parametersFiles                   -   
#> sysShell                          -
#> runMode                           alignReads
#> runThreadN                        1
#> runDirPerm                        User_RWX
#> runRNGseed                        777
#> ...
```

```sh
$ wc -l Log.out
#> 416
```

---

## Check the output (cont.)

- Check the actual indexing output:
  
  ```sh
  $ ls -lh data/ref/Heinz1706_4.00/STAR_index
  
  #> total 7.2G
  #> -rw-r--r-- 1 jelmer PAS0471  116 Feb 10 14:53 chrLength.txt
  #> -rw-r--r-- 1 jelmer PAS0471  246 Feb 10 14:53 chrNameLength.txt
  #> -rw-r--r-- 1 jelmer PAS0471  130 Feb 10 14:53 chrName.txt
  #> -rw-r--r-- 1 jelmer PAS0471  130 Feb 10 14:53 chrStart.txt
  #> -rw-r--r-- 1 jelmer PAS0471 748M Feb 10 14:56 Genome
  #> -rw-r--r-- 1 jelmer PAS0471  734 Feb 10 14:56 genomeParameters.txt
  #> -rw-r--r-- 1 jelmer PAS0471 6.1G Feb 10 14:56 SA
  #> -rw-r--r-- 1 jelmer PAS0471 374M Feb 10 14:56 SAindex
  ```


- Let's move the log files to an appropriate dir:

  ```sh
  $ mkdir -p results/align/log
  $ mv slurm-STAR* out.Log results/align/log/
  ```

---

## STAR options for alignment

Some options for aligning reads to the genome using STAR are  
(_not showing options also shown for the indexing_):

| Option                    | Meaning
|---------------------------|------------
| `--readFilesIn`           | Path to FASTQ file
| `--outFileNamePrefix`     | Path and (**sample**) prefix for output files
| `--outFilterMultimapNmax` | Max. nr. alignments for a read <br> (default: 10)
| `--outSAMtype` | Output sorted BAM (default: SAM) <br> `BAM SortedByCoordinate` for sorted BAM
| `--outSAMunmapped`        | What to do with unmapped reads <br> (default: don't output)

--

.content-box-warning[
Check maximum intron size in GFF:

`--alignIntronMin 20` -- minimum intron length

`--alignIntronMax 1000000` -- maximum intron length
]

---

## The key parts of a script to map reads for 1 sample

```sh
#!/bin/bash
#SBATCH --account=PAS0471
#SBATCH --time=2:00:00
#SBATCH --cpus-per-task=16
module load star/2.6.0a

R1=$(ls "$fastq_dir"/*"$sample"*R1*fastq.gz)
R2=$(ls "$fastq_dir"/*"$sample"*R2*fastq.gz)

STAR --runThreadN "$SLURM_CPUS_ON_NODE" \
   --genomeDir "$index_dir" \
   --sjdbGTFtagExonParentTranscript "$ref_gff" \
   --readFilesIn "$R1" "$R2" \
   --readFilesCommand zcat \
   --outFileNamePrefix "$bam_dir/$sample"_ \
   --outSAMtype BAM SortedByCoordinate
```

--

Submit the script:

```sh
$ sample=C6_myb2_V1N_1_S1_L001
$ bam_dir=results/align/bam
$ sbatch -o "$slurm_log" scripts/align/star_align.sh \
      "$sample" "$fastq_dir" "$index_dir" "$ref_gff" "$bam_dir"
```

---

## Check the output

```sh
$ cat slurm-align-C6_myb2_V1N_1_S1_L001-12836540.out
#> Starting script star_align.sh
#> Thu Feb 11 20:24:21 EST 2021
#> -------------------

#> R1 input file: data/fastq//X6465_Benitez-PonceM_C6_myb2_V1N_1_S1_L001_R1_001.fastq.gz
#> R2 input file: data/fastq//X6465_Benitez-PonceM_C6_myb2_V1N_1_S1_L001_R2_001.fastq.gz
#> Genome index dir: data/ref/Heinz1706_4.00/STAR_index
#> Genome annotation file: data/ref/annot/ITAG4.1/ITAG4.1_gene_models.gff
#> Bam (output) directory: results/align/bam

#> Running STAR....
#> Feb 11 20:24:21 ..... started STAR run
#> Feb 11 20:24:21 ..... loading genome
#> Feb 11 20:24:27 ..... started mapping
```

---

## Check the output (cont.)

```sh
$ ls $bam_dir
```

---

## A script to loop over all files

```sh
#!/bin/bash

samples=($(cat "$sample_list"))

for sample in "${samples[@]}"; do

  R1=$(ls "$fastq_dir"/*"$sample"*_R1_*fastq.gz)

  slurm_log=slurm-align-"$sample"-%j.out 

  echo "Submitting star_align.sh for $sample"
  sbatch -o "$slurm_log" scripts/align/star_align.sh \
      "$sample" "$fastq_dir" "$index_dir" "$ref_gff" "$bam_dir"

done
```

---

## Submit the loop script

```sh
$ ./scripts/align/star_align_loop.sh
    "$sample_list" "$fastq_dir" "$index_dir" "$ref_gff" "$bam_dir"
    
#> Starting script star_align_loop.sh
#> Wed Feb 10 21:03:13 EST 2021
#> -------------------
#> 
#> FASTQ dir: data/fastq/2020-02-18/links
#> Sample list: data/meta/samples.txt
#> Genome index dir: data/ref/Heinz1706_4.00/STAR_index
#> Genome annotation file: data/ref/annot/ITAG4.1/ITAG4.1_gene_models.gff
#> Bam (output) directory: results/align/bam
#> 
#> Submitting star_align.sh for C6_myb2_V1N_1_S1_L001
#> Submitted batch job 12830287
#> Submitting star_align.sh for C6_myb2_V1N_1_S1_L002
#> Submitted batch job 12830289
#> Submitting star_align.sh for C6_myb3_V1N_1_S2_L001
#> Submitted batch job 12830291
#> Submitting star_align.sh for C6_myb3_V1N_1_S2_L002
#> Submitted batch job 12830293
#> ...
```

---

## Checking the output

```sh
$ grep "Uniquely mapped" results/align/bam/star_logs/*Log.final*
```

---

## Running MultiQC on the logs

```sh
$ scripts/QC_fastq/multiqc.sh \
    results/align/bam/star_logs results/align/bam/star_logs
```
