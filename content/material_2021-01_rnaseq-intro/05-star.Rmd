---
title: "RNAseq read alignment with STAR at OSC"
output:
  xaringan::moon_reader:
    seal: false
    css: ["default", "default-fonts", "slides.css"]
    lib_dir: libs
    nature:
      highlightStyle: rainbow
      highlightLines: true
      countIncrementalSlides: false
---
class:inverse middle center

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)

knitr::opts_chunk$set(eval = FALSE)
```

# RNAseq read alignment with STAR at OSC

----

<br> <br> <br>

### Jelmer Poelstra, MCIC Wooster
### 2021/02/17 (updated: `r Sys.Date()`)
  
---

## Overview of the analysis pipeline

<p align="center">
<img src=img/pipeline-overview2.png width="90%">
</p>

---

## Aligning RNAseq reads

The purpose of aligning reads, also known as *mapping*:  
**determine where in the genome each read originates from.**
  
Aligning RNAseq reads is more challenging than DNA reads:
due to *splicing*, many reads can't be simply be mapped wholly to the genome.
  
Moreover, there is often *alternative splicing*,
such that a single "correct" reference is simply not applicable.

<figure>
<p align="center">
<img src="img/DNA_alternative_splicing.gif" width="75%">
<figcaption>Figure from <a href="https://en.wikipedia.org/wiki/Alternative_splicing#/media/File:DNA_alternative_splicing.gif">Wikipedia</a></figcaption>
</p>
</figure>

---

## Aligning RNAseq reads (cont.)

Three different strategies are possible &ndash; but mapping to the genome
is preferable as long as a reference genome is available:

<br>

<figure>
<p align="center">
<img src="img/mapping-strategies.png" width="85%">
<figcaption>Figures from <a href="https://www.nature.com/articles/nmeth1010-793">Cloonan & Grimmond 2010</a></figcaption>
</p>
</figure>

---

## Aligning RNAseq reads (cont.)

Therefore, RNAseq mappers have to be "splice-aware":

<br>

<figure>
<p align="center">
<img src="img/star-map.png" width="80%">
<figcaption>Figure from Dobin et al. 2013</figcaption>
</p>
</figure>

---

## Alignment output: SAM/BAM files

- SAM/BAM files contain the original reads *along with the genomic coordinates
  to which they were mapped* (and more information).

- We get 1 SAM/BAM file for each sample with both the forward and the reverse
  reads (not 2 separate files like for FASTQ files).

--

- SAM is an uncompressed text file and BAM is its binary, compressed counterpart.
  
  - SAM: Sequence Alignment/Map
  
  - BAM: Binary Alignment/Map

  - Most software can work directly with BAM files, and you can use programs
    like Samtools to view them.
  
- For subsequent analyses, BAM files usually also need to be *sorted* by
  genomic coordinates (e.g. with Samtools but also STAR).

---

## The STAR aligner

**About STAR:**

- STAR is an acronym for "Spliced Transcripts Alignment to a Reference".

- Reference paper &ndash; Dobin et al. 2013, *Bioinformatics*: [STAR: ultrafast
  universal RNA-seq aligner](https://academic.oup.com/bioinformatics/article/29/1/15/272537).

- [This page](https://hbctraining.github.io/Intro-to-rnaseq-hpc-O2/lessons/03_alignment.html)
  has a nice quick, visual explanation of STAR's alignment strategy.

- It's a very fast aligner, but memory-intensive. Luckily we have OSC!

--

<br>

.content-box-info[
Before we can perform the mapping, we also need to index the genome with STAR.
Every mapper has its own mapping algorith and associated with that also its
own way to create a genome dictionary.
]

---

## STAR at OSC

- STAR is available in a module at OSC. The Owens cluster has a more recent
  version available, so make sure to log in to the Owens cluster.

  ```sh
  $ cd /fs/project/PAS0471/teach/misc/2021-02_rnaseq/$USER
  ```
  
  ```sh
  $ module load star/2.6.0a
  ```

---

## STAR options for genome indexing

Some options when generating a genome index with STAR are as follows:

| Option                        | Meaning
|-------------------------------|---------
| `--runThreadN 18`             | Use 18 cores/threads
| `--runMode genomeGenerate`    | The mode to index a genome
| `--genomeDir mydir`           | Destination dir for index 
| `--genomeFastaFiles my.fasta` | Path to the genome FASTA file
| `--sjdbGTFfile my.gtf`        | Path to the genome GTF file
| `--sjdbOverhang ReadLength-1` | Length of the donor/acceptor sequence <br> on each side of the junctions
| `--genomeSAindexNbases 14`    | Length of the SA pre-indexing string

--

.content-box-info[
According to the documentation `genomeSAindexNbases` should be:

`log2(GenomeLength)/2 - 1)` => `log2(782520133)/2 - 1)` = 13.77 = 14
]

---

## The key parts of a script to index the genome

```sh
#!/bin/bash
#SBATCH --account=PAS0471
#SBATCH --time=2:00:00
#SBATCH --cpus-per-task=18
module load star/2.6.0a

STAR --runThreadN "$SLURM_CPUS_ON_NODE" \
    --runMode genomeGenerate \
    --genomeDir "$index_dir" \
    --genomeFastaFiles "$ref_fa" \
    --sjdbGTFtagExonParentTranscript "$ref_gff" \
    --genomeSAindexNbases 13 \
    --sjdbOverhang ReadLength-1
```

--

Submit the script:

```sh
$ ref_fa=data/ref/Heinz1706_4.00/S_lycopersicum_chromosomes.4.00.fa
$ ref_gff=data/ref/annot/ITAG4.1/ITAG4.1_gene_models.gff
$ index_dir=data/ref/Heinz1706_4.00/STAR_index

$ sbatch scripts/align/star_index.sh \
    "$ref_fa" "$ref_gff" "$index_dir"
#> Submitted batch job 12826056
```

---

## Check the output

```sh
$ ls
#> slurm-STAR-index-12826056.out Log.out

$ cat slurm-STAR-index-12826056.out
#> Feb 10 14:53:19 ..... started STAR run
#> Feb 10 14:53:19 ... starting to generate Genome files
#> Feb 10 14:53:34 ... starting to sort Suffix Array. This may take a long time...
#> Feb 10 14:53:39 ... sorting Suffix Array chunks and saving them to disk...
#> Feb 10 14:55:09 ... loading chunks from disk, packing SA...
#> Feb 10 14:55:28 ... finished generating suffix array
#> Feb 10 14:55:28 ... generating Suffix Array index
#> Feb 10 14:56:15 ... completed Suffix Array index
#> Feb 10 14:56:15 ... writing Genome to disk ...
#> Feb 10 14:56:15 ... writing Suffix Array to disk ...
#> Feb 10 14:56:18 ... writing SAindex to disk
#> Feb 10 14:56:18 ..... finished successfully
```

---

## Check the output (cont.)

STAR also automatically outputs a file `Log.out` with lots of information
about the run:
  
```sh
$ less Log.out

#> STAR version=STAR_2.6.0a
#> STAR compilation time,server,dir=Mon Apr 23 13:19:26 EDT 2018 #> florence.cshl.edu:/sonas-hs/gingeras/nlsas_norepl/user/dobin/STAR/STAR.master/source
#> ##### DEFAULT parameters:
#> versionSTAR                       20201
#> versionGenome                     20101   20200   
#> parametersFiles                   -   
#> sysShell                          -
#> runMode                           alignReads
#> runThreadN                        1
#> runDirPerm                        User_RWX
#> runRNGseed                        777
#> ...
```

```sh
$ wc -l Log.out
#> 416
```

---

## Check the output (cont.)

- Check the actual indexing output:
  
  ```sh
  $ ls -lh data/ref/Heinz1706_4.00/STAR_index
  
  #> total 7.2G
  #> -rw-r--r-- 1 jelmer PAS0471  116 Feb 10 14:53 chrLength.txt
  #> -rw-r--r-- 1 jelmer PAS0471  246 Feb 10 14:53 chrNameLength.txt
  #> -rw-r--r-- 1 jelmer PAS0471  130 Feb 10 14:53 chrName.txt
  #> -rw-r--r-- 1 jelmer PAS0471  130 Feb 10 14:53 chrStart.txt
  #> -rw-r--r-- 1 jelmer PAS0471 748M Feb 10 14:56 Genome
  #> -rw-r--r-- 1 jelmer PAS0471  734 Feb 10 14:56 genomeParameters.txt
  #> -rw-r--r-- 1 jelmer PAS0471 6.1G Feb 10 14:56 SA
  #> -rw-r--r-- 1 jelmer PAS0471 374M Feb 10 14:56 SAindex
  ```

---

## STAR options for alignment

Some options for aligning reads to the genome using STAR are  
(_not showing options also shown for the indexing_):

| Option                    | Meaning
|---------------------------|------------
| `--readFilesIn`           | Path to FASTQ file
| `--outFileNamePrefix`     | Path and (**sample**) prefix for output files
| `--outFilterMultimapNmax` | Max. nr. alignments for a read <br> (default: 10)
| `--outSAMtype` | Output sorted BAM (default: SAM) <br> `BAM SortedByCoordinate` for sorted BAM
| `--outSAMunmapped`        | What to do with unmapped reads <br> (default: don't output)

--

.content-box-warning[
Check maximum intron size in GFF:

`--alignIntronMin 20` &mdash; minimum intron length

`--alignIntronMax 1000000` &mdash; maximum intron length
]

---

## The key parts of a script to map reads for 1 sample

```sh
#!/bin/bash
#SBATCH --time=2:00:00
#SBATCH --cpus-per-task=18
module load star/2.6.0a

R1=$(ls "$fastq_dir"/*"$sample"*R1*fastq.gz)
R2=$(ls "$fastq_dir"/*"$sample"*R2*fastq.gz)

STAR --runThreadN "$SLURM_CPUS_ON_NODE" \
   --genomeDir "$index_dir" \
   --sjdbGTFtagExonParentTranscript "$ref_gff" \
   --readFilesIn "$R1" "$R2" \
   --readFilesCommand zcat \
   --outFileNamePrefix "$bam_dir/$sample"_ \
   --outSAMtype BAM SortedByCoordinate
```

--

**Submit the script:**

```sh
$ sample=C6_myb2
$ fastq_dir=data/fastq_concat
$ bam_dir=results/align/bam
$ sbatch -o "$slurm_log" scripts/align/star_align.sh \
      "$sample" "$fastq_dir" "$index_dir" "$ref_gff" "$bam_dir"
```

---

## Check the output

```sh
$ cat slurm-align-C6_myb2-12836540.out
#> Starting script star_align.sh
#> Thu Feb 11 20:24:21 EST 2021
#> -------------------

#> R1 input file: data/fastq_concat/C6_myb2_R1.fastq.gz
#> R2 input file: data/fastq_concat/C6_myb2_R2.fastq.gz
#> Genome index dir: data/ref/Heinz1706_4.00/STAR_index
#> Genome annotation file: data/ref/annot/ITAG4.1/ITAG4.1_gene_models.gff
#> Bam (output) directory: results/align/bam

#> Running STAR....
#> Feb 11 20:24:21 ..... started STAR run
#> Feb 11 20:24:21 ..... loading genome
#> Feb 11 20:24:27 ..... started mapping
```

---

## Check the output (cont.)

```sh
$ du -sh results/align/bam/*bam
#> 230M    results/align/bam/C6_myb2_Aligned.sortedByCoord.out.bam


$ ls $bam_dir/star_logs
#> results/align/bam/star_logs/C6_myb2_Log.final.out
#> results/align/bam/star_logs/C6_myb2_Log.out
#> results/align/bam/star_logs/C6_myb2_Log.progress.out
#> results/align/bam/star_logs/C6_myb2_SJ.out.tab
```

---

## Check the output (cont.)

```sh
$ less results/align/bam/star_logs/C6_myb2_Log.final.out
# Started job on                            | Feb 15 20:47:51
# Started mapping on                        | Feb 15 20:47:59
# Finished on                               | Feb 15 20:50:19
# Mapping speed, Million of reads per hour  | 65.57
# Number of input reads                     | 2549920
# Average input read length                 | 276
# UNIQUE READS:     
# Uniquely mapped reads number              | 1945474
# Uniquely mapped reads %                   | 76.30%
# Average mapped length                     | 277.75
# Number of splices: Total                  | 1487782
# Number of splices: Annotated (sjdb)       | 0
# Number of splices: GT/AG                  | 1451397
# Number of splices: GC/AG                  | 14313
# Number of splices: AT/AC                  | 747
# Number of splices: Non-canonical          | 21325
# Mismatch rate per base, %                 | 0.18%
# Deletion rate per base                    | 0.01%
# Deletion average length                   | 1.02
# Insertion rate per base                   | 0.01%
# Insertion average length                  | 2.63
```

---

## Check the output (cont.)

```sh
# [...continuing results/align/bam/star_logs/C6_myb2_Log.final.out]
# MULTI-MAPPING READS:
# Number of reads mapped to multiple loci   | 42055
# % of reads mapped to multiple loci        | 1.65%
# Number of reads mapped to too many loci   | 1977
# % of reads mapped to too many loci        | 0.08%
# UNMAPPED READS:
# % of reads unmapped: too many mismatches  | 0.31%
# % of reads unmapped: too short            | 19.12%
# % of reads unmapped: other                | 2.55%
# CHIMERIC READS:
# Number of chimeric reads                  | 0
# % of chimeric reads                       | 0.00%
```

---

## Check the output (cont.)

```sh
$ less results/align/bam/star_logs/C6_myb2_Log.out
# STAR version=STAR_2.6.0a
# STAR compilation time,server,dir=Mon Apr 23 13:19:26 EDT 2018 # florence.cshl.edu:/sonas-hs/gingeras/nlsas_norepl/user/dobin/STAR/STAR.master/source
# ##### DEFAULT parameters:
# versionSTAR                       20201
# versionGenome                     20101   20200   
# parametersFiles                   -   
# sysShell                          -
# runMode                           alignReads
# 
# ...
# ...
# 
# Loading Genome ... done! state: good=1 eof=0 fail=0 bad=0; loaded 784072704 bytes
# SA file size: 6455421245 bytes; state: good=1 eof=0 fail=0 bad=0
# Loading SA ... done! state: good=1 eof=0 fail=0 bad=0; loaded 6455421245 bytes
# Loading SAindex ... done: 391468491 bytes
# Finished loading the genome: Mon Feb 15 20:47:59 2021
# 
# alignIntronMax=alignMatesGapMax=0, the max intron size will be approximately determined by # (2^winBinNbits)*winAnchorDistNbins=589824
# Created thread # 1
# Created thread # 2
# Created thread # 3
```

---

## Check the output (cont.)

```sh
$ cat results/align/bam/star_logs/C6_myb2_Log.progress.out

#           Time    Speed        Read     Read   Mapped   Mapped   Mapped   Mapped Unmapped Unmapped Unmapped Unmapped
#                    M/hr      number   length   unique   length   MMrate    multi   multi+       MM    short    other
# Feb 15 20:49:27     48.8     1192672      276    76.3%    277.8     0.2%     1.6%     0.1%     0.3%    19.1%     2.6%
# ALL DONE!
```

---

## Check the output (cont.)

```sh
$ less results/align/bam/star_logs/C6_myb2_SJ.out.tab
# SL4.0ch00       18299   19023   1       1       0       1       0       12
# SL4.0ch00       1253757 1264285 2       2       0       0       1       46
# SL4.0ch00       1259569 1263678 2       2       0       1       0       47
# SL4.0ch00       1259569 1264285 2       2       0       1       0       26
# SL4.0ch00       1263726 1264285 2       2       0       2       1       47
# SL4.0ch00       1376108 1376905 1       5       0       0       1       33
# SL4.0ch00       1386429 1387446 1       1       0       0       1       55
# SL4.0ch00       1389552 1390217 0       0       0       0       18      66
# SL4.0ch00       1457286 1457951 0       0       0       0       18      65
# SL4.0ch00       1470754 1471439 1       5       0       0       1       64
# SL4.0ch00       1531568 1532365 1       5       0       0       1       33
# SL4.0ch00       1541889 1542906 1       1       0       0       1       55
# SL4.0ch00       1545012 1545677 0       0       0       0       18      66
# SL4.0ch00       1903425 1905479 2       2       0       0       1       53
# SL4.0ch00       1903425 1946574 2       2       0       0       1       53
# SL4.0ch00       2044995 2046903 0       0       0       0       6       32
# SL4.0ch00       2497375 2498040 0       0       0       0       18      65
# SL4.0ch00       2510840 2511525 1       5       0       0       1       64
# SL4.0ch00       2574688 2575704 2       2       0       0       1       55
```

---

## A script to loop over all files

```sh
#!/bin/bash

samples=($(cat "$sample_list"))

for sample in "${samples[@]}"; do

  R1=$(ls "$fastq_dir"/*"$sample"*_R1*fastq.gz)

  slurm_log=slurm-align-"$sample"-%j.out 

  echo "Submitting star_align.sh for $sample"
  sbatch -o "$slurm_log" scripts/align/star_align.sh \
      "$sample" "$fastq_dir" "$index_dir" "$ref_gff" "$bam_dir"

done
```

---

## Submit the loop script

```sh
$ ./scripts/align/star_align_loop.sh
    "$sample_list" "$fastq_dir" "$index_dir" "$ref_gff" "$bam_dir"
    
#> Starting script star_align_loop.sh
#> Wed Feb 10 21:03:13 EST 2021
#> -------------------
#> 
#> FASTQ dir: data/fastq_concat
#> Sample list: data/meta/samples.txt
#> Genome index dir: data/ref/Heinz1706_4.00/STAR_index
#> Genome annotation file: data/ref/annot/ITAG4.1/ITAG4.1_gene_models.gff
#> Bam (output) directory: results/align/bam
#> 
#> Submitting star_align.sh for C6_myb2
#> Submitted batch job 12830287
#> Submitting star_align.sh for C6_myb2
#> Submitted batch job 12830289
#> Submitting star_align.sh for C6_myb3
#> Submitted batch job 12830291
#> Submitting star_align.sh for C6_myb3
#> Submitted batch job 12830293
#> ...
```

---

## Check the output (cont.)

```sh
$ du -sh $bam_dir/*bam
#> 230M    results/align/bam/C6_myb2_Aligned.sortedByCoord.out.bam
#> 270M    results/align/bam/C6_myb3_Aligned.sortedByCoord.out.bam
#> 183M    results/align/bam/C6_myb4_Aligned.sortedByCoord.out.bam
#> 237M    results/align/bam/cnt_1_Aligned.sortedByCoord.out.bam
#> 240M    results/align/bam/cnt_2_Aligned.sortedByCoord.out.bam
#> 211M    results/align/bam/cnt_3_Aligned.sortedByCoord.out.bam
#> 274M    results/align/bam/CT_05_Aligned.sortedByCoord.out.bam
#> 254M    results/align/bam/CT_06_Aligned.sortedByCoord.out.bam
#> 286M    results/align/bam/CT_09_Aligned.sortedByCoord.out.bam
#> 275M    results/align/bam/myb_1_Aligned.sortedByCoord.out.bam
#> 285M    results/align/bam/myb_2_Aligned.sortedByCoord.out.bam
#> 292M    results/align/bam/myb_3_Aligned.sortedByCoord.out.bam
#> 251M    results/align/bam/T_26_Aligned.sortedByCoord.out.bam
#> 284M    results/align/bam/T_29_Aligned.sortedByCoord.out.bam
#> 0       results/align/bam/T_30_Aligned.sortedByCoord.out.bam
```

---

## Check the output (cont.)

```sh
$ grep "Uniquely mapped" results/align/bam/star_logs/*Log.final*
#> C6_myb2_Log.final.out: Uniquely mapped reads % |   76.30%
#> C6_myb3_Log.final.out: Uniquely mapped reads % |   79.46%
#> C6_myb4_Log.final.out: Uniquely mapped reads % |   56.44%
#> cnt_1_Log.final.out:   Uniquely mapped reads % |   71.11%
#> cnt_2_Log.final.out:   Uniquely mapped reads % |   78.40%
#> cnt_3_Log.final.out:   Uniquely mapped reads % |   66.60%
#> CT_05_Log.final.out:   Uniquely mapped reads % |   80.29%
#> CT_06_Log.final.out:   Uniquely mapped reads % |   81.05%
#> CT_09_Log.final.out:   Uniquely mapped reads % |   86.46%
#> myb_1_Log.final.out:   Uniquely mapped reads % |   87.14%
#> myb_2_Log.final.out:   Uniquely mapped reads % |   86.76%
#> myb_3_Log.final.out:   Uniquely mapped reads % |   87.18%
#> T_26_Log.final.out:    Uniquely mapped reads % |   85.01%
#> T_29_Log.final.out:    Uniquely mapped reads % |   86.01%
```

---

## Running MultiQC on the STAR logs

```sh
$ sbatch scripts/qc/multiqc.sh results/align/bam/star_logs
```
